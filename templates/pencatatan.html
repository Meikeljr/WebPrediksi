{% extends "base.html" %} {% block title %}Pencatatan Transaksi{% endblock %} {%
block content %}

<!-- ==================== SECTION: HEADER ==================== -->
<h1 class="h3 mb-3 text-dark">Pencatatan Transaksi</h1>

<!-- ==================== SECTION: TAB NAVIGATION ==================== -->
<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
  <li class="nav-item" role="presentation">
    <a
      class="nav-link {% if active_tab == 'penjualan' %}active{% endif %}"
      href="{{ url_for('pencatatan') }}"
    >
      <i data-feather="trending-up" class="me-2 icon"></i> Pemasukan
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a
      class="nav-link {% if active_tab == 'pengeluaran' %}active{% endif %}"
      href="{{ url_for('pengeluaran') }}"
    >
      <i data-feather="trending-down" class="me-2 icon"></i> Pengeluaran
    </a>
  </li>
</ul>

<!-- ==================== SECTION: TAB CONTENT ==================== -->
<div class="tab-content">
  {% if active_tab == 'penjualan' %}
  <div class="tab-pane fade show active">
    <!-- ==================== SECTION: FORM PENJUALAN ==================== -->
    <div class="card p-4 shadow-sm mb-4">
      <form method="POST" action="{{ url_for('pencatatan') }}">
        <h5 class="card-title mb-3">Formulir Pencatatan Penjualan</h5>

        <div class="mb-3">
          <input
            type="date"
            class="form-control"
            id="tanggal"
            name="tanggal"
            required
          />
        </div>

        <div class="mb-3">
          <input
            type="text"
            class="form-control"
            id="nama_produk"
            name="nama_produk"
            placeholder="Nama Produk"
            required
          />
        </div>

        <div class="mb-4">
          <input
            type="number"
            class="form-control"
            id="harga"
            name="harga"
            required
            min="0"
            step="any"
            placeholder="Tota Penjualan"
          />
        </div>

        <button type="submit" class="btn btn-primary">Simpan Penjualan</button>
      </form>
    </div>

    <!-- ==================== SECTION: TABEL PENJUALAN + FILTER ==================== -->
    <div class="card p-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Daftar Pencatatan Penjualan</h5>
        <button
          class="btn btn-sm btn-outline-primary"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapsePenjualan"
          aria-expanded="false"
          aria-controls="collapsePenjualan"
        >
          <i data-feather="eye" class="icon-sm"></i> Tampilkan/Sembunyikan
        </button>
      </div>

      <div class="collapse" id="collapsePenjualan">
        <div class="mb-4 p-3 border rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-bold">Filter Berdasarkan Tanggal</h6>
            <div>
              <button id="applyFilterPenjualan" class="btn btn-primary btn-sm">
                Terapkan Filter
              </button>
              <button
                id="clearFilterPenjualan"
                class="btn btn-outline-secondary btn-sm ms-2"
              >
                Hapus Filter
              </button>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <input
                type="number"
                class="form-control"
                id="filterTahun"
                placeholder="Tahun"
                min="2025"
                max="2100"
              />
            </div>
            <div class="col-md-4">
              <select class="form-select" id="filterBulan">
                <option value="">-- Pilih Bulan --</option>
                <option value="01">Januari</option>
                <option value="02">Februari</option>
                <option value="03">Maret</option>
                <option value="04">April</option>
                <option value="05">Mei</option>
                <option value="06">Juni</option>
                <option value="07">Juli</option>
                <option value="08">Agustus</option>
                <option value="09">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12">Desember</option>
              </select>
            </div>
            <div class="col-md-4">
              <input
                type="number"
                class="form-control"
                id="filterHari"
                placeholder="Hari"
                min="1"
                max="31"
              />
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover" id="penjualanTable">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Nama Produk</th>
                <th>Harga Total (Rp)</th>
              </tr>
            </thead>
            <tbody>
              {% if list_penjualan %} {% for penjualan in list_penjualan %}
              <tr>
                <td>{{ penjualan.tanggal }}</td>
                <td>{{ penjualan.produk }}</td>
                <td>Rp {{ "{:,.2f}".format(penjualan.harga_total|float) }}</td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="3" class="text-center">
                  Belum ada data penjualan tercatat.
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %} {% if active_tab == 'pengeluaran' %}
  <div class="tab-pane fade show active">
    <!-- ==================== SECTION: FORM PENGELUARAN ==================== -->
    <div class="card p-4 shadow-sm mb-4">
      <form method="POST" action="{{ url_for('pengeluaran') }}">
        <h5 class="card-title mb-3">Formulir Pencatatan Pengeluaran</h5>

        <div class="mb-3">
          <input
            type="date"
            class="form-control"
            id="tanggal_pengeluaran"
            name="tanggal"
            required
          />
        </div>

        <div class="mb-3">
          <input
            type="text"
            class="form-control"
            id="deskripsi_pengeluaran"
            name="deskripsi_pengeluaran"
            placeholder="Deskripsi Pengeluaran"
            required
          />
        </div>

        <div class="mb-4">
          <input
            type="number"
            class="form-control"
            id="jumlah_biaya"
            name="jumlah_biaya"
            required
            min="0"
            step="any"
            placeholder="Total Pengeluaran"
          />
        </div>

        <button type="submit" class="btn btn-danger">Simpan Pengeluaran</button>
      </form>
    </div>

    <!-- ==================== SECTION: TABEL PENGELUARAN + FILTER ==================== -->
    <div class="card p-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Riwayat Pengeluaran Terbaru</h5>
        <button
          class="btn btn-sm btn-outline-danger"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapsePengeluaran"
          aria-expanded="false"
          aria-controls="collapsePengeluaran"
        >
          <i data-feather="eye" class="icon-sm"></i> Tampilkan/Sembunyikan
        </button>
      </div>

      <div class="collapse" id="collapsePengeluaran">
        <div class="mb-4 p-3 border rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-bold">Filter</h6>
            <div>
              <button id="applyFilterPengeluaran" class="btn btn-danger btn-sm">
                Terapkan Filter
              </button>
              <button
                id="clearFilterPengeluaran"
                class="btn btn-outline-secondary btn-sm ms-2"
              >
                Hapus Filter
              </button>
            </div>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <input
                  type="number"
                  class="form-control"
                  id="filterTahunPengeluaran"
                  placeholder="Tahun"
                  min="2025"
                  max="2100"
                />
              </div>
              <div class="col-md-4">
                <select class="form-select" id="filterBulanPengeluaran">
                  <option value="">-- Pilih Bulan --</option>
                  <option value="01">Januari</option>
                  <option value="02">Februari</option>
                  <option value="03">Maret</option>
                  <option value="04">April</option>
                  <option value="05">Mei</option>
                  <option value="06">Juni</option>
                  <option value="07">Juli</option>
                  <option value="08">Agustus</option>
                  <option value="09">September</option>
                  <option value="10">Oktober</option>
                  <option value="11">November</option>
                  <option value="12">Desember</option>
                </select>
              </div>
              <div class="col-md-4">
                <input
                  type="number"
                  class="form-control"
                  id="filterHariPengeluaran"
                  placeholder="Hari"
                  min="1"
                  max="31"
                />
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table
              class="table table-striped table-hover"
              id="pengeluaranTable"
            >
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Deskripsi</th>
                  <th>Jumlah Biaya (Rp)</th>
                </tr>
              </thead>
              <tbody>
                {% if list_pengeluaran %} {% for pengeluaran in list_pengeluaran
                %}
                <tr>
                  <td>{{ pengeluaran.tanggal }}</td>
                  <td>{{ pengeluaran.deskripsi }}</td>
                  <td>Rp {{ "{:,.2f}".format(pengeluaran.biaya|float) }}</td>
                </tr>
                {% endfor %} {% else %}
                <tr>
                  <td colspan="3" class="text-center">
                    Belum ada data pengeluaran tercatat.
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endblock %} {% block scripts %}
  <script>
    $(document).ready(function () {
      /* ==================== SECTION: DATATABLE CONFIG ==================== */
      const dataTableConfig = {
        responsive: true,
        language: { url: "//cdn.datatables.net/plug-ins/1.11.5/i18n/id.json" },
        lengthMenu: [
          [10, 20, 25, -1],
          ["10 Baris", "20 Baris", "25 Baris", "Semua"],
        ],
        dom: "lfrtip",
        order: [[0, "desc"]],
      };

      let penjualanTable;
      let pengeluaranTable;

      /* ==================== SECTION: INIT DATATABLE ==================== */
      if ($("#penjualanTable").length) {
        penjualanTable = $("#penjualanTable").DataTable(dataTableConfig);
      }

      if ($("#pengeluaranTable").length) {
        pengeluaranTable = $("#pengeluaranTable").DataTable(dataTableConfig);
      }

      /* ==================== SECTION: FILTER KUSTOM ==================== */
      $.fn.dataTable.ext.search.push(function (settings, data) {
        const tableId = settings.nTable.id;
        const tanggal = data[0];

        let filterTahun = "";
        let filterBulan = "";
        let filterHari = "";

        if (tableId === "penjualanTable") {
          filterTahun = $("#filterTahun").val();
          filterBulan = $("#filterBulan").val();
          filterHari = $("#filterHari").val();
        } else if (tableId === "pengeluaranTable") {
          filterTahun = $("#filterTahunPengeluaran").val();
          filterBulan = $("#filterBulanPengeluaran").val();
          filterHari = $("#filterHariPengeluaran").val();
        } else {
          return true;
        }

        if (!filterTahun && !filterBulan && !filterHari) {
          return true;
        }

        if (filterHari !== "") {
          filterHari = filterHari.padStart(2, "0");
        }

        const dataTahun = tanggal.substring(0, 4);
        const dataBulan = tanggal.substring(5, 7);
        const dataHari = tanggal.substring(8, 10);

        let matchTahun = true;
        let matchBulan = true;
        let matchHari = true;

        if (filterTahun) matchTahun = dataTahun === filterTahun;
        if (filterBulan) matchBulan = dataBulan === filterBulan;
        if (filterHari) matchHari = dataHari === filterHari;

        return matchTahun && matchBulan && matchHari;
      });

      /* ==================== SECTION: EVENT PENJUALAN ==================== */
      if ($("#penjualanTable").length) {
        $("#applyFilterPenjualan").on("click", function () {
          penjualanTable.draw();
        });

        $("#clearFilterPenjualan").on("click", function () {
          $("#filterTahun").val("");
          $("#filterBulan").val("");
          $("#filterHari").val("");
          penjualanTable.draw();
        });
      }

      /* ==================== SECTION: EVENT PENGELUARAN ==================== */
      if ($("#pengeluaranTable").length) {
        $("#applyFilterPengeluaran").on("click", function () {
          pengeluaranTable.draw();
        });

        $("#clearFilterPengeluaran").on("click", function () {
          $("#filterTahunPengeluaran").val("");
          $("#filterBulanPengeluaran").val("");
          $("#filterHariPengeluaran").val("");
          pengeluaranTable.draw();
        });
      }
    });
  </script>
  {% endblock %}
</div>
